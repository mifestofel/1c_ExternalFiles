// 2024 год, январь (последние изменения)

&НаКлиенте
Процедура ПриОткрытии(Отказ) 
	Элементы.diff_цвет.Видимость = Ложь;
КонецПроцедуры

&НаКлиенте
Процедура Сравнить(Команда)
	Изменения = СопоставитьСтроки(Блок1, Блок2);
	ВывестиDIFF(Изменения);
	
	ИзменениеФормыDIFF();
КонецПроцедуры 

&НаКлиенте
Процедура ОчиститьDIFF(Команда)
	ОчиститьHTMLДокумент();	
КонецПроцедуры

&НаКлиенте
Процедура ОчиститьИВернутьсяDIFF(Команда)
	ОчиститьHTMLДокумент(Истина);
КонецПроцедуры

&НаКлиенте
Процедура ИзменениеФормыDIFF()

	Элементы.diff_цвет.Видимость = Истина;
	ПереходНаСтраницу = ЭтаФорма.Элементы.ГруппаСтраницы.ПодчиненныеЭлементы.Найти("diff_цвет");
	ЭтаФорма.Элементы.ГруппаСтраницы.ТекущаяСтраница = ПереходНаСтраницу; 
	
КонецПроцедуры

&НаКлиенте
Процедура ОчиститьHTMLДокумент(ПерейтиНазад = Ложь)

	ДокументHTML = "<html><body></body></html>"; 
	Если ПерейтиНазад = Истина Тогда
		ПереходНаОсновнуюСтраницу();		
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ПереходНаОсновнуюСтраницу()

	ПереходНаСтраницу = ЭтаФорма.Элементы.ГруппаСтраницы.ПодчиненныеЭлементы.Найти("Страница2Текста");
	ЭтаФорма.Элементы.ГруппаСтраницы.ТекущаяСтраница = ПереходНаСтраницу; 	

КонецПроцедуры

&НаСервере
Функция АлгоритмЛевинштайна(Строка1, Строка2)

	Длина1 = СтрДлина(Строка1);
    Длина2 = СтрДлина(Строка2);

    Если Длина1 > Длина2 Тогда
        Временная = Строка1;
        Строка1 = Строка2;
        Строка2 = Временная;

        Временная = Длина1;
        Длина1 = Длина2;
        Длина2 = Временная;
    КонецЕсли;

    ТекущаяСтрока = Новый Массив();
    Для Символ_i = 0 По Длина1 Цикл
        ТекущаяСтрока.Добавить(Символ_i);
    КонецЦикла;

    Для Символ_i = 1 По Длина2 Цикл
        ПредыдущаяСтрока = ТекущаяСтрока;
        ТекущаяСтрока = Новый Массив();
        ТекущаяСтрока.Добавить(Символ_i);

        Для Символ_j = 1 По Длина1 Цикл
            СтоимостьДобавления = ПредыдущаяСтрока[Символ_j] + 1;
            СтоимостьУдаления = ТекущаяСтрока[Символ_j - 1] + 1;
            СтоимостьЗамены = ПредыдущаяСтрока[Символ_j - 1];
            
            Если Сред(Строка1, Символ_j, 1) <> Сред(Строка2, Символ_i, 1) Тогда
                СтоимостьЗамены = СтоимостьЗамены + 1;
            КонецЕсли;

            // Выбираем минимальную стоимость операции
            ТекущаяСтрока.Добавить(Мин(СтоимостьДобавления, СтоимостьУдаления, СтоимостьЗамены));
        КонецЦикла;
    КонецЦикла;
	
	Возврат ТекущаяСтрока[Длина1];
	
КонецФункции  
	
&НаКлиенте
Процедура ПодсчитатьРасстояниеМеждуСтрок(Команда)
	АлгоритмЛевинштайна(Блок1, Блок2);
КонецПроцедуры

&НаСервере
Функция СопоставитьСтроки(Текст1, Текст2)
    // Разделяем текст на строки
    МассивСтрок1 = СтрРазделить(Текст1, Символы.ПС);
    МассивСтрок2 = СтрРазделить(Текст2, Символы.ПС);
	МассивРезультат = Новый Массив;

    Результат = Новый Массив();
	
	Пока МассивСтрок1.Количество() <> 0 Цикл 
		Если МассивСтрок2.Количество() = 0 Тогда
			//МассивРезультат.Добавить("<p style=""margin: 0; background-color: #f8d7da;""> &ndash;&nbsp;|&nbsp;" + МассивСтрок1[0] + "</p>");
			МассивРезультат.Добавить(
										"<tr class=""red-column"">
										|	<td class=""first-column"">&ndash;</td>
										|	<td class=""visible-line"">" + МассивСтрок1[0] + "</td>
										|</tr>");
			МассивСтрок1.Удалить(0);
			Продолжить;
		КонецЕсли;
		
		Если МассивСтрок1[0] = МассивСтрок2[0] Тогда
			
			//МассивРезультат.Добавить("<p style=""margin: 0;"">&nbsp;&nbsp;&nbsp;|&nbsp;" + МассивСтрок1[0] + "</p>");
			МассивРезультат.Добавить(
										"<tr>
										|	<td class=""first-column""></td>
										|	<td class=""visible-line"">" + МассивСтрок1[0] + "</td>
										|</tr>");

			МассивСтрок2.Удалить(0);
			МассивСтрок1.Удалить(0);
		Иначе
			
			Индекс1 = МассивСтрок2.Найти(МассивСтрок1[0]); 
			Если ЗначениеЗаполнено(Индекс1) Тогда
				
				Индекс2 = МассивСтрок1.Найти(МассивСтрок2[0]);
				Если ЗначениеЗаполнено(Индекс2) Тогда
					//МассивРезультат.Добавить("<p style=""margin: 0; background-color: #f8d7da;"">  &ndash;&nbsp;|&nbsp;" + МассивСтрок1[0] + "</p>");
					МассивРезультат.Добавить(
										"<tr class=""red-column"">
										|	<td class=""first-column"">&ndash;</td>
										|	<td class=""visible-line"">" + МассивСтрок1[0] + "</td>
										|</tr>");
					МассивСтрок1.Удалить(0);

					//МассивРезультат.Добавить("<p style=""margin: 0; background-color: #d4edda;"">  +&nbsp;|&nbsp;" + МассивСтрок2[0] + "</p>");
					МассивРезультат.Добавить(
										"<tr class=""green-column"">
										|	<td class=""first-column"">+</td>
										|	<td class=""visible-line"">" + МассивСтрок2[0] + "</td>
										|</tr>");
					МассивСтрок2.Удалить(0);
					
				Иначе
					//МассивРезультат.Добавить("<p style=""margin: 0; background-color: #d4edda;"">  +&nbsp;|&nbsp;" + МассивСтрок2[0] + "</p>");
					МассивРезультат.Добавить(
										"<tr class=""green-column"">
										|	<td class=""first-column"">+</td>
										|	<td class=""visible-line"">" + МассивСтрок2[0] + "</td>
										|</tr>");
					МассивСтрок2.Удалить(0);
				КонецЕсли;
			Иначе
				//МассивРезультат.Добавить("<p style=""margin: 0; background-color: #f8d7da;"">  &ndash;&nbsp;|&nbsp;" + МассивСтрок1[0] + "</p>");
				МассивРезультат.Добавить(
										"<tr class=""red-column"">
										|	<td class=""first-column"">&ndash;</td>
										|	<td class=""visible-line"">" + МассивСтрок1[0] + "</td>
										|</tr>");
				
				//МассивРезультат.Добавить("<p style=""margin: 0; background-color: #d4edda;"">  +&nbsp;|&nbsp;" + МассивСтрок2[0] + "</p>");
				МассивРезультат.Добавить(
										"<tr class=""green-column"">
										|	<td class=""first-column"">+</td>
										|	<td class=""visible-line"">" + МассивСтрок2[0] + "</td>
										|</tr>");
				МассивСтрок2.Удалить(0);
				МассивСтрок1.Удалить(0);
			КонецЕсли;
			
		КонецЕсли;	
	КонецЦикла;
		
	Если МассивСтрок2.Количество() > 0 Тогда
		Для Каждого Строка2 Из МассивСтрок2 Цикл
			//МассивРезультат.Добавить("<p style=""margin: 0; background-color: #d4edda;"">  +&nbsp;|&nbsp;" + МассивСтрок2[0] + "</p>");
			МассивРезультат.Добавить(
										"<tr class=""green-column"">
										|	<td class=""first-column"">+</td>
										|	<td class=""visible-line"">" + МассивСтрок2[0] + "</td>
										|</tr>");
			МассивСтрок2.Удалить(0);	
		КонецЦикла;
	КонецЕсли;
		
	Возврат МассивРезультат;

КонецФункции

&НаКлиенте
Процедура ВывестиDIFF(Изменения)
	
	СтрокаHTML = "";
	Для Каждого Правка Из Изменения Цикл
		СтрокаHTML = СтрокаHTML + Правка + Символы.ПС;	
	КонецЦикла;
		
	ДокументHTML = "<html lang=""ru"">
					|<head>
					|    <meta charset=""UTF-8"">
					|    <meta name=""viewport"" content=""width=device-width, initial-scale=1.0"">
					|    <title>Таблица с одной видимой линией</title>
					|    <style>
					|        table {
					|            border-collapse: collapse;
					|            width: 100%;
					|        }
					|        td, th {
					|            border: none;
					|        }
					|        .visible-line {
					|            border-left: 1px solid black;
					|			 padding-left: 5px;
					|        }
					|        .first-column {
					|            width: 20px;
					|			 text-align: center;
					|        }
					|        .green-column {
					|            background-color: #d4edda;
					|        }
					|        .red-column {
					|            background-color: #f8d7da;
					|        }
					|    </style>
					|</head>
					|<body>
					|    <table>" + Символы.ПС + СтрокаHTML + Символы.ПС + "   </table></body></html>";
	
	
КонецПроцедуры




